# Build Stage
FROM golang:1.25.7-alpine AS builder
WORKDIR /app

# Version build arg (set by CI or defaults to dev)
ARG VERSION=dev

# Copy go mod files first for better caching
COPY go.mod go.sum ./
RUN go mod download

# Copy source code
COPY . .

# Build the agent binary with version (no CGO needed)
RUN CGO_ENABLED=0 GOOS=linux go build \
    -ldflags="-s -w -X main.version=${VERSION}" \
    -o vigil-agent ./cmd/agent

# Final Stage - Debian for better ZFS/library compatibility
# Use this variant for TrueNAS, FreeBSD-based systems, or when mounting host ZFS tools
FROM debian:bookworm-slim
WORKDIR /app

# Install smartmontools and nvme-cli
# ZFS tools can be:
#   1. Installed here (apt install zfsutils-linux) if host has compatible kernel
#   2. Mounted from host for TrueNAS/FreeBSD compatibility
RUN apt-get update && apt-get install -y --no-install-recommends \
    smartmontools \
    nvme-cli \
    ca-certificates \
    tzdata \
    && rm -rf /var/lib/apt/lists/*

# Copy the binary
COPY --from=builder /app/vigil-agent .

ENV TZ=UTC

ENTRYPOINT ["./vigil-agent"]
CMD ["--server", "http://localhost:9080", "--interval", "60"]